<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier</title>
</head>

<body>
    <header>
        <a href="/front-end/liste-produits.html">Accueil</a>
        <a href="/front-end/panier.html">Panier</a>
    </header>

    <main>
        <h2>Votre panier</h2>
        <div id="listeArticles"></div>
        <div> Total panier: <span id="totalArticles"></span> €</div><br>

        <p>Veuillez remplir le formulaire ci-dessous afin de valider votre commande</p>
        <form id="paiement">
            <fieldset>
                <ul>
                    <li>
                        <label for="firstName">Prénom</label>
                        <input id="firstName" name="firstName" type="text" placeholder="Entrez votre prénom" required>
                    </li>
                    <li>
                        <label for="lastName">Nom</label>
                        <input id="lastName" name="lastName" type="text" placeholder="Entrez votre nom" required
                            autofocus>
                    </li>

                    <li>
                        <label for="address">Adresse</label>
                        <input id="address" name="address" type="text" required>
                    </li>

                    <li>
                        <label for="city">Ville</label>
                        <input id="city" name="city" type="text" required>
                    </li>

                    <li>
                        <label for="email">Email</label>
                        <input id="email" name="email" type="email" placeholder="monadresse@mail.com" required>
                    </li>

                    <div>
                        <button id="send">Envoyer</button>
                    </div>
                </ul>
            </fieldset>
        </form>
    </main>

    <footer>

    </footer>

    <script>
        const sendForm = document.getElementById("send");
        const firstName = document.getElementById("firstName");
        const lastName = document.getElementById("lastName");
        const adress = document.getElementById("address");
        const city = document.getElementById("city");
        const email = document.getElementById("email");

        sendForm.addEventListener('click', e => {
            e.preventDefault();

            const panierForm = [];
            panier.forEach(article => {
                panierForm.push(article.id);
            });

            const body = {
                contact: {
                    firstName: firstName.value,
                    lastName: lastName.value,
                    address: adress.value,
                    city: city.value,
                    email: email.value
                },
                products: panierForm
            };

            fetch("/api/teddies/order", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
                .then(function (res) {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(function (data) {
                    console.log("data", data);
                    data.total = total;
                    localStorage.order = JSON.stringify(data);

                    location.assign("./confirmation.html");
                })
                .catch(function (error) {
                    console.error("Erreur", error);
                });
        });

        function moins(id) {
            const inputQuantite = document.getElementById("quantite_" + id);
            if (inputQuantite.value > 1) {
                inputQuantite.value--;
            }
        }

        function plus(id) {
            const inputQuantite = document.getElementById("quantite_" + id);
            inputQuantite.value++;
        }

        // On créé une fonction qui supprime un produit dans notre panier
        // ici data correspond à une chaine de texte contenant l'id du produit et sa couleur séparés avec un '_'
        function supprimer(data) {
            // On split (découpe) le texte à chaque '_' et on met le résultat dans un tableau 
            data = data.split('_');

            // On filtre le panier pour vérifier si les articles ont le même id et la même couleur
            panier = panier.filter(article => {

                // On retourne tous les articles dans le panier sauf celui qu'on veut supprimer
                // (celui qui a le même id et la même couleur n'est pas retourné et disparaît donc du panier)
                if (article.id != data[0] || article.couleur != data[1]) {
                    return article;
                }
            });

            //On stocke le nouveau panier dans le local storage
            localStorage.panier = JSON.stringify(panier);

            //On actuaise avec reload la page
            location.reload();
        }

        //On charge notre panier vide au départ (si aucun produit n'est séléctionné)
        let panier = [];
        if (localStorage.panier) {
            panier = JSON.parse(localStorage.panier);
        }

        //Faire un lien vers le dom à l'aide de get element by id
        let listePanier = document.getElementById('listeArticles');
        let totalPanier = document.getElementById('totalArticles');

        //On crée une variable contenant le coût total des articles de notre panier
        let total = 0;

        panier.forEach(produit => {
            console.log("produit", produit);

            fetch("/api/teddies/" + produit.id)
                .then(function (res) {
                    if (res.ok) {
                        return res.json();
                    }
                })

                // Ensuite pour chaque article qui sera choisi on aura ses caractéristique nom, couleur, qté
                .then(function (data) {
                    console.log("data", data);

                    //On créer une variable globale total qui multiplie le prix des produits aux quantités
                    total = total + (data.price * produit.quantite);
                    totalPanier.innerText = total / 100;
                    console.log("total", total);

                    /*On charge notre panier plein si l'on séléctionne des articles 
                    pour cela on doit créer celui-ci en html à l'aide de createElement*/
                    let articlePanier = document.createElement('div');
                    // On crée en html les données relatives au produit id qté couleur grâce à la propriété innerHTML
                    articlePanier.innerHTML = `<h4>${data.name}</h4>
                    <img style="width: 10rem;" src="${data.imageUrl}" alt="${data.name}"/>
                    <p>Couleur : ${produit.couleur}</p>
                    <div>
                        <p>Quantité :</p>
                        <button class="bt-moins" onclick="moins('${data._id}_${produit.couleur}')">-</button>
                        <input type="text" id="quantite_${data._id}_${produit.couleur}" class="input_quantite" value="${produit.quantite}" readonly/>
                        <button class="bt-plus" onclick="plus('${data._id}_${produit.couleur}')">+</button>
                        <button class="bt-supprimer" onclick="supprimer('${data._id}_${produit.couleur}')">Supprimer</button>
                    </div>
                    <p>Prix : ${data.price / 100} €</p>`;

                    listePanier.appendChild(articlePanier);
                })

                .catch(function (error) {
                    console.error("Erreur", error);
                });
        });
    </script>
</body>

</html>