<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits</title>
</head>

<body>
    <section>
        <a href="/front-end/liste-produits.html">Accueil</a>
        <a href="/front-end/panier.html">Panier</a>
        <h2 id="title"></h2>
        <img id="imageUrl" src="" />
        <p>
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Recusandae dolorum eum eius! A saepe cupiditate
            quisquam sunt dolore fuga dolorum, odit nobis rerum maiores fugit magnam, officia repellat quae mollitia!
        </p>
        <h3 id="price"></h3>
        <form>
            <h3>Couleur</h3>
            <p>
                <select name="colors-list" id="colors">

                </select>
            </p>

            <h3>Quantité</h3>
            <input id="quantite" type="number" min="1" max="10" value="1"> <br />

            <button id="ajouter">Ajouter au panier</button>
        </form>
        <div>

        </div>
    </section>

    <script>
        // On créer une variable vide pour gérer le panier et on charge les données de localStorage
        // afin de ne pas perdre les données à chaque changement de pages
        let panier = [];
        if (localStorage.panier) {
            panier = JSON.parse(localStorage.panier);
        }

        let donneesProduit;

        const titre = document.getElementById("title");
        const prix = document.getElementById("price");
        const listeCouleur = document.getElementById("colors");
        const image = document.getElementById("imageUrl");
        const quantite = document.getElementById("quantite");

        // On récupère l'id dans l'url
        const url = new URL(document.location.href);
        const id = url.searchParams.get("id");

        fetch("/api/teddies/" + id)
            .then(function (res) {
                if (res.ok) {
                    return res.json();
                }
            })
            .then(function (data) {
                console.log(data);
                donneesProduit = data;
                titre.innerText = data.name;
                prix.innerText = "Prix : " + data.price + "€";
                data.colors.forEach(color => {
                    const ligneCouleur = document.createElement("option");
                    ligneCouleur.value = color;
                    ligneCouleur.innerText = color;
                    listeCouleur.appendChild(ligneCouleur);
                });
                image.src = data.imageUrl;
            })
            .catch(function (err) {
                console.error("Erreur", error);
            });

        //On créer l'évenement ajouter au panier
        const ajouter = document.getElementById("ajouter");

        ajouter.addEventListener('click', event => {
            event.preventDefault();
            const couleur = listeCouleur.options[listeCouleur.selectedIndex].value;
            // On vérifie si les articles déjà présents dans le panier ont le même id
            // et la même couleur afin de ne pas les répeter intempestivement dans notre panier 
            let dejaPresent = false;
            panier.forEach(articlePanier => {
                if (articlePanier.id == donneesProduit._id && articlePanier.couleur == couleur) {
                    articlePanier.quantite = +articlePanier.quantite + +quantite.value;
                    dejaPresent = true;
                }
            });

            if (!dejaPresent) {
                const produit = {
                    "id": donneesProduit._id,
                    "quantite": quantite.value,
                    "couleur": couleur
                }

                panier.push(produit);
            }

            localStorage.panier = JSON.stringify(panier);
            ajouter.innerText = `L'article ${donneesProduit.name} à été ajouté au panier`;

            setTimeout(() => {
                ajouter.innerText = "Ajouter au panier";
            }, 3000);
        });

    </script>
</body>

</html>