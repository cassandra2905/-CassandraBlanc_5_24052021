<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier</title>
</head>

<body>
    <header>
        <a href="/front-end/listProducts.html">Accueil</a>
        <a href="/front-end/cart.html">Panier</a>
    </header>

    <main>
        <h2>Votre panier</h2>
        <div id="listProducts"></div>
        <p>Total panier: <span id="totalProducts"></span> €</p><br>

        <p>Veuillez remplir le formulaire ci-dessous afin de valider votre commande</p>
        <form>
            <ul>
                <li>
                    <label for="firstName">Prénom</label>
                    <input id="firstName" name="firstName" type="text" placeholder="Entrez votre prénom" required>
                </li>
                <li>
                    <label for="lastName">Nom</label>
                    <input id="lastName" name="lastName" type="text" placeholder="Entrez votre nom" required autofocus>
                </li>

                <li>
                    <label for="address">Adresse</label>
                    <input id="address" name="address" type="text" required>
                </li>

                <li>
                    <label for="city">Ville</label>
                    <input id="city" name="city" type="text" required>
                </li>

                <li>
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" placeholder="monadresse@mail.com" required>
                </li>

                <div>
                    <button id="send">Envoyer</button>
                </div>
            </ul>
        </form>
    </main>

    <footer></footer>


    <script src="./js/product.js"></script>
    <script src="./js/listProducts.js"></script>
    <script src="./js/cart.js"></script>

    <script>
        //On crée une constante cart qui contient une nouvelle classe cart 
        const cart = new Cart();

        //On déclare les constantes contenant la liste des produits et le coût total des produits dans le panier
        const listProducts = document.getElementById('listProducts');
        const totalProducts = document.getElementById('totalProducts');

        //On déclare les constantes des champs du formulaire 
        const sendForm = document.getElementById("send");
        const firstName = document.getElementById("firstName");
        const lastName = document.getElementById("lastName");
        const adress = document.getElementById("address");
        const city = document.getElementById("city");
        const email = document.getElementById("email");

        //On déclare la variable du total 
        let total = 0;

        //Pour l'objet produit de la liste des produits dans le panier
        for (const object_product of cart.listProducts) {
            //L'objet produit à pour constructor l' id, la couleur, le nom, la description, le prix, l'image
            const product = new Product(
                object_product.id,
                object_product.color,
                object_product.name,
                object_product.description,
                object_product.price,
                object_product.image
            );

            product.quantity = object_product.quantity;

            total = total + (product.price * product.quantity);

            const divProduct = document.createElement('div');

            //On créé en html les données relatives au produit
            //On créer les boutons pour gérer la quantité d'un produit 
            divProduct.innerHTML = `<h4>${product.name}</h4>
            <img style="width: 10rem;" src="${product.image}" alt="${product.name}"/>
            <p>Couleur : ${product.color}</p>
            <div>
                <p>Quantité :</p>
                <button class="bt-moins" onclick="less('${product.id}', '${product.color}')">-</button>
                <input type="text" class="input_quantite" value="${product.quantity}" readonly/>
                <button class="bt-plus" onclick="more('${product.id}', '${product.color}')">+</button>
                <button class="bt-supprimer" onclick="deleteProduct('${product.id}', '${product.color}')">Supprimer</button>
            </div>
            <p>Prix : ${product.getFormattedPrice()}</p>`;
            //On assigne le prix formaté à notre produit à l'aide de la fonction "getFormattedPrice"
            //On applique le formatage du bloc divProduct contenant les input à la liste des produits 
            listProducts.appendChild(divProduct);
        }

        totalProducts.innerText = total / 100;

        //Annule l'évènment par défaut lors du clic sur le bouton d'envoi du formulaire 
        sendForm.addEventListener('click', e => {
            e.preventDefault();

            // Pour chaque articles dans le panier on récupère l'id qu'on met dans un tableau 
            const idProductsOfCart = cart.getIdProducts();

            const body = {
                contact: {
                    firstName: firstName.value,
                    lastName: lastName.value,
                    address: adress.value,
                    city: city.value,
                    email: email.value
                },
                products: idProductsOfCart
            };

            //On effectue une requête réseau pour envoyer les données concernant notre commande
            //Avec la méthode POST on envoie l'objet contact, le tableau des produits commandés
            /*Une fois le formulaire rempli, on stocke le résultat et on redirige vers la page de 
            confirmation de commande*/
            fetch("/api/teddies/order", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
                .then(function (res) {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(function (data) {
                    console.log("data", data);
                    data.total = total;
                    localStorage.order = JSON.stringify(data);

                    location.assign("./confirmationOrder.html");
                })
                .catch(function (error) {
                    console.error("Erreur", error);
                });
        });

        //Fonction pour dimunuer la quantité d'un produit (actualise le panier)
        function less(id, color) {
            cart.removeProduct({ id, color });
            location.reload();
        }

        //Fonction pour augmenter la quantité d'un produit (actualise le panier)
        function more(id, color) {
            cart.addProduct({ id, color });
            location.reload();
        }

        //Fonction pour supprimer un produit du panier (actualise le panier)
        function deleteProduct(id, color) {
            cart.deleteProductOfCart({ id, color });
            location.reload();
        }
    </script>
</body>

</html>